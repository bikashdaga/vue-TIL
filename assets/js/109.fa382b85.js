(window.webpackJsonp=window.webpackJsonp||[]).push([[109],{647:function(s,t,a){"use strict";a.r(t);var n=a(21),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("유저 모델을 생성하고 페이지 렌더링하는 과정은 mongoDB "),a("a",{attrs:{href:"./210927-mongo"}},[s._v("모델링 1편과")]),s._v(" 동일하다.")]),s._v(" "),a("h2",{attrs:{id:"패스워드-해싱"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#패스워드-해싱"}},[s._v("#")]),s._v(" 패스워드 해싱")]),s._v(" "),a("p",[s._v("패스워드나 민감한 개인정보같은 경우 암호화 작업 없이 DB에 저장하게 되면 데이터가 그대로 노출되게 된다. 암호화 처리를 추가하게 되면 DB상에서 식별될 수 없게 데이터가 바뀌지만 인증에는 문제가 없다.")]),s._v(" "),a("p",[s._v("노드 패키지의 "),a("code",[s._v("bcrypt")]),s._v("를 활용하면 된다. "),a("code",[s._v("npm i bcrypt")]),s._v(" 를 입력하여 설치한다.")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://parkjju.github.io/vue-TIL/daily/210927-mongo.html#mongoose-middleware",target:"_blank",rel:"noopener noreferrer"}},[s._v("몽구스 미들웨어 문서"),a("OutboundLink")],1),s._v("를 참조하여 유저 모델의 패스워드가 DB에 저장되기 전 패스워드 데이터를 해시해야한다.")]),s._v(" "),a("p",[s._v("다음은 "),a("code",[s._v("save")]),s._v(" 직전에 패스워드를 해시해주는 함수이다.")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// .. 스키마 정의")]),s._v("\nuserSchema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("pre")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"save"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Users password: "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("password "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" bcrypt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("hash")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hashed password: "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mongoose.model로 저장")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 모델 익스포트 디폴트")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[a("code",[s._v("bcrypt.hash(data, saltRound, callback)")]),s._v("을 전달하면 된다. 어싱크 어웨이트 문법을 사용하면 콜백은 전달하지 않아도 되고 파라미터 중 "),a("code",[s._v("saltRound")]),s._v("의 경우 오리지널 데이터를 몇 번 해싱 할 것인지 라운드를 정하는 파라미터이다.")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("로그인 기능 중 해시한 비밀번호와 입력된 값의 일치성을 검사하기 위해서는 입력된 패스워드를 "),a("strong",[s._v("saltRound")]),s._v("만큼 해시하여 일치하는지 확인해보면 된다. 직접 해당 기능을 구현해도 되지만 "),a("code",[s._v("bcrypt")]),s._v(" 패키지의 "),a("code",[s._v("compare")]),s._v("를 이용하면 된다.")]),s._v(" "),a("p",[a("code",[s._v('bcrypt.compare("myText", hashValue).then(callback);')])])]),s._v(" "),a("h2",{attrs:{id:"duplicate-key-error-처리"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#duplicate-key-error-처리"}},[s._v("#")]),s._v(" duplicate key error 처리")]),s._v(" "),a("p",[a("code",[s._v("duplicate key error")]),s._v("는 스키마의 데이터에 "),a("code",[s._v("unique")]),s._v("옵션을 부여했음에도 중복되는 값을 DB에 저장하려고 할 때 발생하는 에러이다.")]),s._v(" "),a("p",[s._v("중복 값을 포스트시 DB에서 에러 메세지를 띄우고 무한 로딩을 통해 유효성 검사에서 통과시키지 않지만 에러를 처리해야 사용자 경험이 향상된다.")]),s._v(" "),a("p",[s._v("애러의 처리는 "),a("code",[s._v("Model.exists")]),s._v(" 메서드를 활용하면 된다. 반환값은 불리언 값으로 이후 조건문을 통해 흐름을 제어하면 된다.")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" exists "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("exists")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("$or")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" username "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" email "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[a("code",[s._v("exists")]),s._v(" 메서드의 "),a("code",[s._v("$or")]),s._v("옵션을 지정하면 한꺼번에 여러 데이터에 대해 중복 검사를 진행할 수 있다.")])]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("WARNING")]),s._v(" "),a("p",[s._v("크롬 브라우저에서는 폼으로 유저네임과 패스워드를 입력받은 후 서버로부터 상태 코드를 200 OK를 받게되면 정상적인 입출력으로 판단하여 브라우저에 아이디 및 패스워드 자동완성 데이터로 저장하려고 한다.")]),s._v(" "),a("p",[a("code",[s._v("res.render")]),s._v("같은 메서드는 기본적으로 200 OK를 반환하기 때문에 렌더링이 되어도 잘못된 입력이 이루어졌을 경우 상태 코드를 다르게 반환받아야한다.")]),s._v(" "),a("p",[a("code",[s._v("render")]),s._v("에 상태코드를 보내는 방법은 "),a("code",[s._v('res.status(400).render("")')]),s._v(" 이다. 잘못된 페이지에 대해 올바른 상태 코드를 전달하게 되면 브라우저가 "),a("strong",[s._v("URL")]),s._v("을 히스토리에 저장하지 않는다.")])]),s._v(" "),a("h2",{attrs:{id:"세션과-쿠키"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#세션과-쿠키"}},[s._v("#")]),s._v(" 세션과 쿠키")]),s._v(" "),a("p",[s._v("세션이란 백엔드와 브라우저 간에 어떤 활동을 했는지 기억하는 것을 말한다. 특성 사이트에 로그인했다면 브라우저와 백엔드에 세션이 존재하는 상태이다. 세션 유지에 대한 작업을 추가하지 않은 상태에서 로그인을 하면 로그인 후 서버에서 전달해주는 HTML을 렌더링 한 뒤 세션이 끊어지게 된다. 이를 무상태(stateless)라고 한다.")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("세션은 미들웨어, 쿠키는 쿠키! 세션이 쿠키를 전달한다 라고 이해하자.")])]),s._v(" "),a("p",[s._v("이러한 HTTP의 특성으로 인한 웹서비스 구현 한계를 극복하기 위해 세션과 쿠키를 활용하게 된다.")]),s._v(" "),a("p",[s._v("링크 참조 - "),a("a",{attrs:{href:"http://expressjs.com/en/resources/middleware/session.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("express session"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("세션을 이용하기 위해서는 "),a("code",[s._v("express-session")]),s._v("을 설치하자. "),a("code",[s._v("npm i express-session")])]),s._v(" "),a("p",[s._v("미들웨어 정의를 통해 익스프레스의 세션을 사용할 수 있는데, 라우터 정의 이전에 사용해야한다.")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("session")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("secret")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello!"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("resave")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("saveUninitialized")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[a("code",[s._v("session")]),s._v("메서드는 세션을 생성하고 내부에 옵션들을 전달할 수 있다. 다양한 옵션들이 있지만 예제 코드로 작성된 옵션들만 정리해보면")]),s._v(" "),a("ol",[a("li",[s._v("resave - 모든 리퀘스트마다 기존에 있던 세션에 아무런 변경사항이 없을 시에도 해당 세션을 저장한다. (디폴트가 false로 바뀜)")]),s._v(" "),a("li",[s._v("saveUninitialized - 리퀘스트가 들어오면 해당 리퀘스트에서 새로 생성된 세션에 아무런 작업이 이루어지지 않은 상황을 Uninitialized라고 한다. default는 true이고 resave 옵션과 비슷한 의미를 지닌다.")]),s._v(" "),a("li",[s._v("secret - 세션 아이디를 담는 쿠키의 키값. 변경 시 현재 살아있는 세션들이 모두 무효화된다.")])]),s._v(" "),a("p",[s._v("세션 생성 이후 세션을 통해 다룰 정보를 우리가 직접 추가해줘야 한다. 세션은 브라우저 마다 다르게 생겼기 때문이다.")]),s._v(" "),a("p",[s._v("세션은 기본적으로 객체이기 때문에 정보를 추가하는 것은 어렵지 않다.")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("loggedIn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nreq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("리퀘스트의 세션에 프로퍼티를 추가해주면 된다.")]),s._v(" "),a("p",[s._v("세션에다가 우리가 다룰 정보들을 추가해줬는데 이를 렌더링할 때 사용하기 위해서는 다른 방식을 사용해야한다. 퍼그라는 프레임워크는 세션에 접근할 수 없기 때문이다.")]),s._v(" "),a("p",[s._v("미들웨어 함수들을 담을 자바스크립트 파일 생성 후 서버 자바스크립트 파일에 임포트 한 뒤 다음의 코드처럼 "),a("code",[s._v("locals")]),s._v("라는 리스폰스 오브젝트를 활용한다.")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("localsMiddleware")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("locals"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("siteName "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Wetube"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("locals"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("loggedIn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Boolean")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("loggedIn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("locals"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("loggedInUser "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("session"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("locals"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[a("code",[s._v("locals")]),s._v("오브젝트를 통해 퍼그 템플릿과 익스프레스 둘 다 동시에 접근할 수 있게 된다. 퍼그에서 locals 오브젝트를 사용하기 위해서는 "),a("code",[s._v("#{localsVariable}")]),s._v("형태로 사용하면 된다.")]),s._v(" "),a("div",{staticClass:"language-pug line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-pug"}},[a("code",[a("span",{pre:!0,attrs:{class:"token flow-control"}},[a("span",{pre:!0,attrs:{class:"token branch keyword"}},[s._v("if")]),s._v(" loggedIn")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[s._v("li")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[s._v("a"),a("span",{pre:!0,attrs:{class:"token attributes"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("href")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/logout"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")])])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token plain-text"}},[s._v("Log out")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[s._v("li")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[s._v("a"),a("span",{pre:!0,attrs:{class:"token attributes"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("href")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/my-profile"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")])])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token plain-text"}},[s._v("#{loggedInUser.name}'s Profile")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"mongostore"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mongostore"}},[s._v("#")]),s._v(" MongoStore")]),s._v(" "),a("p",[s._v("쿠키에 저장되는 세션은 세션의 ID만 저장된다. 세션 내용을 데이터베이스에 저장하고싶다면 해당 데이터베이스에 맞는 모듈을 새로 설치해야한다.")]),s._v(" "),a("p",[s._v("몽고 DB의 경우 "),a("code",[s._v("connect-mongo")]),s._v("모듈이 해당한다. 세션을 데이터베이스에 저장하였기 때문에 서버 재시작 후에 데이터베이스만 연결되어 있다면 회원 로그인 상태를 잃어버리지 않고 유지할 수 있게 된다.")]),s._v(" "),a("p",[a("code",[s._v("connect-mongo")]),s._v(" 설치 및 임포트 후 익스프레스 세션 생성 시 사용했던 옵션에 "),a("code",[s._v("store")]),s._v("를 추가해준다. "),a("code",[s._v(".create")]),s._v("메서드에 몽고 데이터베이스 URL까지 전달하면 완료된다.")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" MongoStore "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"connect-mongo"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("session")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("secret")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello!"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("resave")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("saveUninitialized")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("store")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" MongoStore"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("mongoUrl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongodb://127.0.0.1:27017/wetube"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("세션을 데이터베이스에 연결한 뒤 회원정보를 가지고 로그인을 하면 데이터베이스에 세션 데이터와 함께 회원 정보 객체가 기록된다. 따라서 데이터베이스가 삭제되지 않는 이상 백엔드를 재시작해도 로그인 상태를 기억하고 있게 된다.")]),s._v(" "),a("p",[s._v("문제는 "),a("code",[s._v("resave")]),s._v("와 "),a("code",[s._v("saveUninitialized")]),s._v(" 옵션을 "),a("code",[s._v("true")]),s._v("값으로 저장해두면 로그인 한 사용자와 로그인 하지 않은 사용자에 상관 없이 모든 세션을 DB에 저장하기 때문에 서버에 부하가 심하게 걸린다는 것이다.")]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("WARNING")]),s._v(" "),a("p",[a("code",[s._v("Uninitialized")]),s._v("는 세션 생성 후 수정된 적이 없는 상태를 말한다. 세션을 수정은 컨트롤러에서 "),a("code",[s._v("req.session")]),s._v("을 통해 처리하였고 해당 부분에서 실질적인 세션의 초기화가 이루어지는 것이다. "),a("code",[s._v("saveUninitialized")]),s._v("옵션을 "),a("code",[s._v("false")]),s._v("로 설정함으로써 세션의 초기화가 일어날 때만 해당 세션을 DB에 저장하겠다는 것이다.")])]),s._v(" "),a("h2",{attrs:{id:"cookie-property"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cookie-property"}},[s._v("#")]),s._v(" Cookie property")]),s._v(" "),a("ol",[a("li",[s._v("secret : 쿠키에 서명할 때에 남기는 문자열이다. 쿠키에 서명하는 이유는 백엔드가 쿠키를 줬다는 것을 보이기 위함이다. (세션 하이잭 공격을 방어)")]),s._v(" "),a("li",[s._v("Domain : 쿠키를 만든 백엔드가 누구인지 알려준다. (예 - localhost) 도메인으로 쿠키를 보내고 도메인으로부터 쿠키를 받는다.")]),s._v(" "),a("li",[s._v("Expires : 쿠키의 만료 날짜이다.\n"),a("ul",[a("li",[s._v("만료 날짜를 설정해두지 않으면 브라우저가 닫히거나 컴퓨터를 재시작할 때 소멸된다.")]),s._v(" "),a("li",[s._v("maxAge는 밀리세컨드 단위이므로, 1/1000을 계산하여 고려하도록 하자.")])])])]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("use")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("session")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("cookie")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("maxAge")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h2",{attrs:{id:"nodejs-환경변수-처리법"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nodejs-환경변수-처리법"}},[s._v("#")]),s._v(" nodeJS 환경변수 처리법")]),s._v(" "),a("p",[s._v("기본적으로 세션의 "),a("code",[s._v("secret")]),s._v("옵션의 스트링과 "),a("code",[s._v("mongoDB")]),s._v("의 URL은 환경변수로 처리하여 깃에 업로드 해야한다.")]),s._v(" "),a("ol",[a("li",[a("code",[s._v("dotenv")]),s._v(" 모듈을 설치한 뒤"),a("code",[s._v(".env")]),s._v("파일을 생성한다.")]),s._v(" "),a("li",[a("strong",[s._v("As early as possible in your application, require and configure dotenv.")]),s._v(" 권고문에 따라 자신이 "),a("code",[s._v("dotenv")]),s._v(" 모듈을 사용할 모든 자바스크립트 파일에 "),a("code",[s._v("require('dotenv').config()")]),s._v(" 코드를 작성한다.\n"),a("ul",[a("li",[a("code",[s._v("require")]),s._v("가 아닌 "),a("code",[s._v("import")]),s._v("방식을 사용하려면 파일 흐름 상 가장 처음 실행되는 자바스크립트 파일 첫 줄에 "),a("code",[s._v('import "dotenv/config";')]),s._v("를 추가해준다.")])])]),s._v(" "),a("li",[s._v("관례적으로 환경변수 명은 전부 대문자로 작성하며 문자열의 경우에도 따옴표를 붙이지 않는다.\n"),a("ul",[a("li",[a("code",[s._v("COOKIE_SECRET=.....")])])])]),s._v(" "),a("li",[s._v("환경변수를 사용하는 코드를 "),a("code",[s._v("process.env.COOKIE_SECRET")]),s._v("로 대체한다.")])]),s._v(" "),a("h2",{attrs:{id:"로그아웃"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#로그아웃"}},[s._v("#")]),s._v(" 로그아웃")]),s._v(" "),a("p",[s._v("라우터, 컨트롤러 정의하고 "),a("code",[s._v("res.session.destroy()")]),s._v(" 호출하면 끝!")])])}),[],!1,null,null,null);t.default=e.exports}}]);